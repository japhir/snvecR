* [10/21] get snvecR published on CRAN, github, zenodo
:PROPERTIES:
:CREATED:  [2023-04-04 Tue 09:27]
:END:
** DONE play around with the different ODE solver algorithms to figure out which one is fastest
CLOSED: [2023-04-04 Tue 09:28]
** DONE make the R routine visually return the same spin vector as the C routine
CLOSED: [2023-04-04 Tue 09:27]
** WAIT [1/1] make the R routine return machine precision close to identical results to the C routine
:PROPERTIES:
:CREATED:  [2023-04-04 Tue 09:27]
:END:
:LOGBOOK:
- State "WAIT"       from "DONE"       [2023-04-05 Wed 11:02]
- State "DONE"       from "WAIT"       [2023-04-05 Wed 11:02]
- State "WAIT"       from "NEXT"       [2023-04-04 Tue 15:33]
- State "NEXT"       from "WAIT"       [2023-04-04 Tue 13:39]
- State "WAIT"       from "NEXT"       [2023-04-04 Tue 12:51]
:END:
- [X] hmm it's not the fact that in the C routine he doesn't interpolate the results for hh and kk
- [X] check for a long run if the error stays 1e-3 or if it accumulates -> it accumulates, see figs:
   [[file:imgs/2023-04-04_compare-c-to-R_56-54Ma.png]]
   [[file:imgs/2023-04-04_compare-c-to-R_81-78Ma.png]]
   [[file:imgs/2023-04-04_compare-c-to-R_100-97Ma.png]]
- [X] compare C-code to this with times
- almost good enough. For more direct comparison:
- [X] interpolate C results into R timegrid
- [X] calculate the difference
- [X] plot the difference
- [X] do the same for the full solar system solution
*** DONE now do the long run but with a lower tolerance
CLOSED: [2023-04-05 Wed 13:47]
**** 1e-10
#+begin_src R
  lowtol <- snvec(-1e5, 1, 0, tolerance = 1e-10)
  write_rds(lowtol, "out/2023-04-04_lowtol.rds")
#+end_src

#+RESULTS:
: This is snvec.r VERSION: 3.7.5 2023-03-29
: Richard E. Zeebe
: Ilja J. Kocken
: Integration parameters:
:  tend = -1e+05 kyr
:  tres = 0.4 kyr
:  Ed = 1
:  Td = 0
: Final values s[1][2][3]; s-error = |s|-1:
: -0.164426067894575 0.406888350901304 0.898597654927192
: 3.59030270373761e-05
: Final values obliquity, precession (rad):
: 0.3899853310553 1.88486960858406

**** 1e-12
#+begin_src R
  superlowtol <- snvec(-1e5, 1, 0, tolerance = 1e-12)
  write_rds(superlowtol, "out/2023-04-04_superlowtol_1e-12.rds")
#+end_src

#+RESULTS:
: This is snvec.r VERSION: 3.7.5 2023-03-29
: Richard E. Zeebe
: Ilja J. Kocken
: Integration parameters:
: tend = -1e+05 kyr
: tres = 0.4 kyr
: Ed = 1
: Td = 0
:     user   system  elapsed
: 3246.787    0.342 3255.612
: Final values s[1][2][3]; s-error = |s|-1:
: -0.143109361596917 0.419908122882867 0.896212779992251
: 2.34030537171748e-07
: Final values obliquity, precession (rad):
: 0.390596711702826 1.8189284314666

**** 1e-07
#+begin_src R
  normtol <- snvec(-1e5, 1, 0, tolerance = 1e-7)
  write_rds(normtol, "out/2023-04-04_normtol_1e-7.rds")
#+end_src

#+RESULTS:
#+begin_example
Integration parameters:
 tend = -1e+05 kyr
 Ed = 1
 Td = 0
 orbital_solution = ZB18a
 tres = 0.4 kyr
 tolerance = 1e-07
starting at Wed Apr  5 09:55:48 2023
   user  system elapsed
 24.575   0.010  24.699
Final values s[1][2][3]; s-error = |s|-1:
-0.181186234717299 0.377666080230894 0.902100420308931
-0.00539189218589675
Final values obliquity, precession (rad):
0.389933827834007 1.96689170415452
stopped at Wed Apr  5 09:56:46 2023
#+end_example
**** 1e-03
#+begin_src R
  hightol <- snvec(-1e5, 1, 0, tolerance = 1e-3)
  write_rds(hightol, "out/2023-04-05_hightol_1e-3.rds")
#+end_src

#+RESULTS:
#+begin_example
Integration parameters:
 tend = -1e+05 kyr
 Ed = 1
 Td = 0
 orbital_solution = ZB18a
 tres = 0.4 kyr
 tolerance = 0.001
started at 2023-04-05 10:12:39
   user  system elapsed
 22.583   0.000  22.659
Final values s[1][2][3]; s-error = |s|-1:
-0.1069277059072 0.423122991463078 0.893789976171586
-0.00535075443649757
Final values obliquity, precession (rad):
0.392041645216932 1.72794012401827
stopped at Wed Apr  5 10:13:33 2023
total duration 54.119035243988
#+end_example

**** make the comparison between resolutions
** DONE [3/3] make the R routine return the same values for precession and obliquity
CLOSED: [2023-04-04 Tue 13:38]
:PROPERTIES:
:CREATED:  [2023-04-04 Tue 09:29]
:END:
- [X] epl
- [X] cp
- [X] phi => there's something weird going on with the mapping to -pi to pi, but it works if I fix that manually
  rldpeace

** DONE make a function out of snvec so it's easy to vary Td and Ed
CLOSED: [2023-04-04 Tue 18:10]
:PROPERTIES:
:CREATED:  [2023-04-04 Tue 09:28]
:END:
#+begin_src R
  ## devtools::load_all()
  test <- snvec(-1e3, 1, 0)
#+end_src

#+RESULTS:
#+begin_example
Integration parameters:
 tend = -1000 kyr
 Ed = 1
 Td = 0
 orbital_solution = ZB18a
 tres = 0.4 kyr
 tolerance = 1e-07
starting at Tue Apr  4 23:06:34 2023
   user  system elapsed
  0.211   0.000   0.213
Final values s[1][2][3]; s-error = |s|-1:
0.404197400723194 -0.0537088738295803 0.91303387030935
-5.44863786333671e-05
Final values obliquity, precession (rad):
0.413056573207875 -0.562236553023642
stopped at Tue Apr  4 23:06:35 2023
#+end_example

rldpeace

** DONE calculate for grids of Td and Ed
CLOSED: [2023-04-05 Wed 15:55]
:PROPERTIES:
:CREATED:  [2023-04-04 Tue 09:29]
:END:
:LOGBOOK:
- State "DONE"       from "WAIT"       [2023-04-05 Wed 15:13]
- State "WAIT"       from "DONE"       [2023-04-05 Wed 13:16]
:END:

*** create the desired grid for Td and Ed
:PROPERTIES:
:CREATED:  [2023-04-05 Wed 11:03]
:END:
#+begin_src R :output none :eval never
  snvec_tail <- function(...) {
      # do the fit with the parameters in ...
      snvec(...) |>
      # save only the last 1000 values, that's where the differences are the worst
      tail(n = 1000) |>
      # convert deSolve columns to numerics for easy combinations
      mutate(across(c(time, sx, sy, sz, age, epl), as.numeric))
  }

  # same grid as in Zeebe & Lourens 2022 table 2: 10.1029/2021PA004349
  biggrid <- expand.grid(Td = c(0, 0.5, 0.7, 0.8, 0.9, 1.0, 1.1, 1.2),
              Ed = c(1.000, 0.998, 1.005, 1.012)) |>
    # that's 32 rows
    as_tibble() |>
    # for now only for 1000 years so it's fast
    ## mutate(tol = 1e-4, tend = -1e3) |>
    # the real deal, full results at medium tolerance
    # this will run but will run out of memory too...
    # limit results to final 1000 timesteps (400 kyr) or so?
    mutate(tol = 1e-7, tend = -1e5) |>
    # apply our new function!
    mutate(sol = pmap(list(td = Td, ed = Ed, tend = tend, tolerance = tol),
                      .f = snvec_tail, quiet = TRUE,
                      .progress = "snvec on a grid")) |>
    write_rds("out/2023-04-05_biggrid.rds")
#+end_src

#+begin_src R
   biggrid <- read_rds("out/2023-04-05_biggrid.rds")
#+end_src

#+RESULTS:

#+begin_src R
  # unnest the new list column
  expanded <- biggrid |>
    unnest(sol)
#+end_src

#+RESULTS:
*** plot the results
#+begin_src R :results output graphics file :file imgs/2023-04-05_experimental-grid_full.png :width 1920 :height 1080
  # then make a plot
  expanded |>
    ggplot(aes(x = age, y = cp,
               colour = factor(Td),
               linetype = factor(Ed))) +
    scale_x_reverse("Age (ka)") +
    ## facet_grid(rows = vars(Ed)) +
    facet_grid(rows = vars(Td)) +
    geom_line() +
    geom_line(aes(y = eei))
#+end_src

#+RESULTS:
[[file:imgs/2023-04-05_experimental-grid_full.png]]

*** plot the results for phi
#+begin_src R :results output graphics file :file imgs/2023-04-05_experimental-grid_phi.png :width 1920 :height 1080
  # then make a plot
  expanded |>
    ggplot(aes(x = age, y = phi,
               colour = factor(Td),
               linetype = factor(Ed))) +
    scale_x_reverse("Age (ka)") +
    ## facet_grid(rows = vars(Ed)) +
    facet_grid(rows = vars(Td)) +
    geom_line()
#+end_src

#+RESULTS:
[[file:imgs/2023-04-05_experimental-grid_phi.png]]

*** bin the results
#+begin_src R :results output graphics file :file imgs/2023-04-05_experimental-grid_full_bin.png :width 700
  expanded |>
    ggplot(aes(x = cp,
               fill = factor(Td)## ,
               ## group = factor(Ed)
               )) +
    ## facet_grid(rows = vars(Td)) +
    ## geom_histogram() +
    ggdist::stat_halfeye(alpha = .4)
#+end_src

#+RESULTS:
[[file:imgs/2023-04-05_experimental-grid_full_bin.png]]

** SOME visualize results: a heat map?
:PROPERTIES:
:CREATED:  [2023-04-04 Tue 09:29]
:END:
:LOGBOOK:
- State "SOME"       from "NEXT"       [2023-04-05 Wed 15:55]
:END:
for that I'd need to have the difference function with a record
** SOME make the La2011 solution obl + precession available?
:PROPERTIES:
:CREATED:  [2023-04-04 Tue 10:35]
:END:
:LOGBOOK:
- State "SOME"       from "NEXT"       [2023-04-04 Tue 10:36]
:END:
but NOT the 2004 solutions! divergence times at ~40 Ma with 2011 or ZB18a
** SOME check out the Wu paper / acycle
:PROPERTIES:
:CREATED:  [2023-04-04 Tue 10:37]
:END:
:LOGBOOK:
- State "SOME"       from "NEXT"       [2023-04-04 Tue 10:39]
:END:
they apply the Laskar fortran routine from 92/93 to calculate precession/obliquity for the La2011 but that's in the ecliptic reference plane rather than the intertial reference frame.
** SOME add a progress bar
:PROPERTIES:
:CREATED:  [2023-04-04 Tue 18:23]
:END:
:LOGBOOK:
- State "SOME"       from              [2023-04-04 Tue 18:23]
:END:
https://github.com/r-lib/progress#readme
** DONE document all function parameters correctly
CLOSED: [2023-04-05 Wed 13:45]
:PROPERTIES:
:CREATED:  [2023-04-04 Tue 18:45]
:END:
https://style.tidyverse.org/documentation.html#documenting-parameters
** DONE add return docs to each function
CLOSED: [2023-04-05 Wed 13:45]
:PROPERTIES:
:CREATED:  [2023-04-04 Tue 18:46]
:END:
** SOME make it possible for snvec to write to file
:LOGBOOK:
- State "SOME"       from              [2023-04-05 Wed 13:20]
:END:
add a file = NULL argument
at the end
#+begin_src R :eval never :tangle no
if(!is.null(file)) { readr::write_rds(fin, file = file) }
#+end_src
** docs tips from pkgs
:PROPERTIES:
:CREATED:  [2023-04-04 Tue 18:48]
:END:
https://r-pkgs.org/man.html
** DONE write nice error messages in the tidyverse style
CLOSED: [2023-04-05 Wed 12:27]
:PROPERTIES:
:CREATED:  [2023-04-04 Tue 18:44]
:END:
https://style.tidyverse.org/error-messages.html
and info messages
** NEXT [#B] fix unwrap tests
:PROPERTIES:
:CREATED:  [2023-04-05 Wed 13:45]
:END:
[[file:tests/testthat/test-unwrap.R]]

** DONE move the code out of here for reals -> pkg structure is single source of truth
CLOSED: [2023-04-05 Wed 20:19]
:PROPERTIES:
:CREATED:  [2023-04-04 Tue 18:49]
:END:
:LOGBOOK:
- State "DONE"       from "SOME"       [2023-04-05 Wed 20:19]
- State "SOME"       from              [2023-04-04 Tue 18:49]
:END:

** NEXT update CITATION to cite the package on CRAN itself
:PROPERTIES:
:CREATED:  [2023-04-05 Wed 15:55]
:END:
[[file:~/SurfDrive/Postdoc1/prj/2023-03-23_snvec-R/inst/CITATION][file:~/SurfDrive/Postdoc1/prj/2023-03-23_snvec-R/inst/CITATION]]

** NEXT make the text of my plots bigger for Richard
:PROPERTIES:
:CREATED:  [2023-04-05 Wed 20:19]
:END:

** NEXT build the R package cleanly
:PROPERTIES:
:CREATED:  [2023-04-06 Thu 09:02]
:END:
#+begin_src R
  devtools::check()
#+end_src

#+begin_src R :eval query
  rcmdcheck::rcmdcheck()
#+end_src

#+begin_example
✔  checking whether the namespace can be unloaded cleanly (560ms)
W  checking loading without being on the library search path
   Error: package or namespace load failed for ‘snvecR’ in loadNamespace(j <- i[[1L]], c(lib.loc, .libPaths()), versionCheck = vI[[j]]):
    there is no package called ‘cli’
   Execution halted

   It looks like this package has a loading problem when not on .libPaths:
   see the messages for details.
#+end_example

I deleted =R_LIBS= from my [[file:~/.Renviron]]

** NEXT make the code/package citable
:PROPERTIES:
:CREATED:  [2023-04-06 Thu 14:22]
:END:
fixed [[file:inst/CITATION]] so that it works
used R package citation::r2cff() to generate a template cff file
